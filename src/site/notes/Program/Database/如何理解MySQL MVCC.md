---
{"dg-publish":true,"permalink":"/Program/Database/如何理解MySQL MVCC/","noteIcon":"","created":"2025-03-06T21:28:25.969+08:00"}
---

MySQL 的多版本并发控制（MVCC, Multi-Version Concurrency Control）是一种用于处理数据库并发的机制。它允许多个事务并发执行，同时确保数据一致性并避免锁争用，从而提高数据库的性能。

### MVCC 的工作原理

MVCC 通过为每一行数据保存多个版本来实现。当一个事务对数据进行修改时，不会直接覆盖现有数据，而是创建该行数据的一个新版本。每个版本都会包含事务的标识信息以及时间戳信息。这样，在同一时刻，不同事务可以读取或操作相同的数据行的不同版本，而不会发生冲突。

#### MVCC 的几个关键点：

1. **隐藏列（系统列）：** 每个数据行都有两个隐藏列，用于存储创建版本和删除版本的事务 ID。创建版本表示该数据行是由哪个事务插入的，删除版本表示该数据行是由哪个事务删除的。
   
2. **事务隔离级别：** MVCC 一般在 MySQL 的 InnoDB 存储引擎中实现，支持的隔离级别是 "READ COMMITTED" 和 "REPEATABLE READ"。在 "REPEATABLE READ" 隔离级别下，MVCC 能够实现快照读（Snapshot Read），即事务在开始时的一个时间点上的数据视图。在这个级别下，事务在执行过程中看到的数据版本不会改变，除非显式更改（通过加锁操作）。

3. **读操作：**
   - **快照读 (Snapshot Read):** 事务读取数据时获取的是数据的快照副本。快照读不会锁定数据，因此多个事务可以并发读取。
   - **当前读 (Current Read):** 读取最新的数据版本（可能是其他事务修改的）。当前读需要对数据行进行加锁，以保证数据一致性和避免冲突。

4. **写操作：** 插入（Insert）、更新（Update）、删除（Delete）操作会创建新的数据版本，而不是覆盖现有的数据行版本。每个事务只会看到在其启动之前提交的更改和其自身所做的更改。

### MVCC 的优点

- **高并发性：** 由于读操作不加锁，多个事务可以同时读取数据，而不需要等待锁释放。
- **更低的锁争用：** 只在需要写操作时加锁，因此减少了锁的争用和死锁的可能性。
- **一致性读取：** 提供一致的视图，保证事务内部的数据一致性。

### MVCC 的缺点

- **空间开销：** 每次写操作都会创建一个新的版本，旧版本的数据会占用额外的存储空间，直到不再需要这些旧版本。
- **版本回收的开销：** 随着时间的推移，需要回收旧的版本，以释放存储空间，这个过程可能带来额外的系统开销。

### 总结

MySQL 的 MVCC 提供了一种高效的并发控制方式，适用于高并发的读写场景，尤其是在读多写少的场景下。通过多版本的方式，它允许读操作不加锁，从而大幅提升了性能和响应速度。